<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJSK 歌曲紀錄卡</title>
    <style>
        :root {
            --bg-easy: #AED581;   /* 淺綠 */
            --bg-normal: #64B5F6; /* 淺藍 */
            --bg-hard: #FFF176;   /* 黃 */
            --bg-expert: #E57373; /* 紅 */
            --bg-master: #BA68C8; /* 紫 */
            --bg-append: #F48FB1; /* 粉 */
            
            --btn-gray: #e0e0e0;
            --btn-fc: #4caf50;    /* 綠色 */
            --btn-ap: #ffd700;    /* 金色 */
        }


        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }


        /* 控制區塊 */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }


        input, select, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }


        button.primary {
            background-color: #33b5e5;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }


        button.primary:hover {
            background-color: #0099cc;
        }


        /* 歌曲卡片容器 */
        #song-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }


        /* 單張卡片 */
        .card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }


        .card-header {
            display: flex;
            padding: 10px;
            background: #333;
            color: white;
            align-items: center;
            gap: 10px;
        }


        .card-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            background: #555;
        }


        .card-title {
            font-size: 1.1em;
            font-weight: bold;
            flex-grow: 1;
        }


        .playlist-tag {
            font-size: 0.8em;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }


        /* 難易度列表 */
        .diff-row {
            display: grid;
            grid-template-columns: 60px 50px 1fr auto; /* 名稱 | 等級 | 備註 | 按鈕 */
            align-items: center;
            padding: 5px 10px;
            gap: 8px;
            border-bottom: 1px solid #eee;
        }


        .diff-label {
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
            padding: 2px;
            border-radius: 4px;
            color: #333;
        }


        /* 顏色定義 */
        .easy { background-color: var(--bg-easy); }
        .normal { background-color: var(--bg-normal); }
        .hard { background-color: var(--bg-hard); }
        .expert { background-color: var(--bg-expert); }
        .master { background-color: var(--bg-master); color: white; }
        .append { background-color: var(--bg-append); }


        .level-input {
            width: 100%;
            text-align: center;
        }


        .memo-input {
            width: 100%;
            font-size: 0.8em;
        }


        /* FC/AP 按鈕群組 */
        .btn-group {
            display: flex;
            gap: 2px;
        }


        .status-btn {
            border: none;
            padding: 4px 8px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            color: #555;
            background-color: var(--btn-gray);
            transition: all 0.2s;
        }


        .status-btn:first-child { border-radius: 4px 0 0 4px; }
        .status-btn:last-child { border-radius: 0 4px 4px 0; }


        /* 狀態啟動樣式 */
        .status-btn.fc-active {
            background-color: var(--btn-fc);
            color: white;
        }
        .status-btn.ap-active {
            background-color: var(--btn-ap);
            color: #5d4037; /* 深褐色字體 */
        }


        /* 播放清單控制區 */
        .card-footer {
            padding: 10px;
            background: #f9f9f9;
            text-align: right;
        }


    </style>
</head>
<body>


    <h1>Project Sekai 歌曲紀錄表</h1>


    <div class="controls">
        <div style="display:flex; gap:10px; align-items:center; border-right: 1px solid #ddd; padding-right: 20px;">
            <h3>新增歌曲</h3>
            <input type="text" id="newSongTitle" placeholder="輸入歌名...">
            <input type="file" id="newSongImg" accept="image/*">
            <button class="primary" onclick="addSong()">新增卡片</button>
        </div>


        <div style="display:flex; gap:10px; align-items:center;">
            <h3>篩選系統</h3>
            <select id="filterType" onchange="renderSongs()">
                <option value="all">顯示全部</option>
                <option value="playlist">播放清單分類</option>
                <option value="level">等級分類 (System)</option>
            </select>
            
            <input type="text" id="filterValue" placeholder="輸入清單名稱 或 等級數字" oninput="renderSongs()">
        </div>
        
        <button onclick="clearData()" style="background:#ff4444; color:white; margin-left:auto;">清除所有資料</button>
    </div>


    <div id="song-container">
        </div>


    <script>
        // 難易度設定
        const difficulties = [
            { key: 'easy', label: 'EASY', class: 'easy' },
            { key: 'normal', label: 'NORMAL', class: 'normal' },
            { key: 'hard', label: 'HARD', class: 'hard' },
            { key: 'expert', label: 'EXPERT', class: 'expert' },
            { key: 'master', label: 'MASTER', class: 'master' },
            { key: 'append', label: 'APPEND', class: 'append' }
        ];


        // 資料儲存結構 (從 LocalStorage 讀取或初始化)
        let songs = JSON.parse(localStorage.getItem('pjsk_songs')) || [];


        // 初始化
        window.onload = () => {
            renderSongs();
        };


        // 儲存資料到 LocalStorage
        function saveData() {
            localStorage.setItem('pjsk_songs', JSON.stringify(songs));
            renderSongs(); // 重新渲染以更新視圖
        }


        // 新增歌曲
        function addSong() {
            const titleInput = document.getElementById('newSongTitle');
            const imgInput = document.getElementById('newSongImg');
            
            if (!titleInput.value) {
                alert("請輸入歌名！");
                return;
            }


            // 處理圖片 (將圖片轉為 Base64 字串以便存入 LocalStorage)
            let imgSrc = "https://placehold.co/60x60?text=No+Img"; // 預設圖
            
            const createSongRecord = (image) => {
                const newSong = {
                    id: Date.now(),
                    title: titleInput.value,
                    image: image,
                    playlist: "", // 播放清單
                    records: {} // 紀錄每個難度的狀態
                };


                // 初始化每個難度的資料
                difficulties.forEach(d => {
                    newSong.records[d.key] = {
                        level: "",
                        status: "none", // none, fc, ap
                        memo: ""
                    };
                });


                songs.unshift(newSong); // 加到最前面
                saveData();
                titleInput.value = "";
                imgInput.value = "";
            };


            if (imgInput.files && imgInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    createSongRecord(e.target.result);
                }
                reader.readAsDataURL(imgInput.files[0]);
            } else {
                createSongRecord(imgSrc);
            }
        }


        // 更新難度資料 (等級、備註)
        function updateRecord(id, diffKey, field, value) {
            const song = songs.find(s => s.id === id);
            if (song) {
                song.records[diffKey][field] = value;
                // 這裡不呼叫 renderSongs 以避免輸入時失焦，改為僅儲存
                localStorage.setItem('pjsk_songs', JSON.stringify(songs));
            }
        }


        // 切換狀態 (None -> FC -> AP -> None) 或點擊特定按鈕
        function setStatus(id, diffKey, type) {
            const song = songs.find(s => s.id === id);
            if (song) {
                const currentStatus = song.records[diffKey].status;
                
                // 如果點擊的是已經激活的狀態，則取消 (變回 none)
                // 如果點擊的是新狀態，則切換過去
                if (currentStatus === type) {
                    song.records[diffKey].status = 'none';
                } else {
                    song.records[diffKey].status = type;
                }
                saveData();
            }
        }


        // 更新播放清單
        function updatePlaylist(id, value) {
            const song = songs.find(s => s.id === id);
            if (song) {
                song.playlist = value;
                localStorage.setItem('pjsk_songs', JSON.stringify(songs));
            }
        }


        // 刪除歌曲
        function deleteSong(id) {
            if(confirm("確定要刪除這首歌嗎？")) {
                songs = songs.filter(s => s.id !== id);
                saveData();
            }
        }
        
        function clearData() {
            if(confirm("警告：這將清除所有紀錄！確定嗎？")) {
                localStorage.removeItem('pjsk_songs');
                songs = [];
                renderSongs();
            }
        }


        // 渲染畫面 (核心邏輯)
        function renderSongs() {
            const container = document.getElementById('song-container');
            const filterType = document.getElementById('filterType').value;
            const filterValue = document.getElementById('filterValue').value.toLowerCase();
            
            container.innerHTML = "";


            // 篩選邏輯
            let displaySongs = songs.filter(song => {
                if (filterType === 'all') return true;
                
                if (filterType === 'playlist') {
                    return song.playlist.toLowerCase().includes(filterValue);
                }
                
                if (filterType === 'level') {
                    // 檢查這首歌的任一難度是否符合輸入的等級
                    return Object.values(song.records).some(r => r.level === filterValue);
                }
                return true;
            });


            displaySongs.forEach(song => {
                // 建立卡片 HTML
                const card = document.createElement('div');
                card.className = 'card';


                // 卡片頭部
                let headerHtml = `
                    <div class="card-header">
                        <img src="${song.image}" class="card-img">
                        <div class="card-title">
                            ${song.title} <br>
                            ${song.playlist ? `<span class="playlist-tag">📂 ${song.playlist}</span>` : ''}
                        </div>
                        <button onclick="deleteSong(${song.id})" style="background:#ff5555; color:white; border:none; padding:5px;">✕</button>
                    </div>
                `;


                // 難度列表
                let rowsHtml = '';
                difficulties.forEach(diff => {
                    const rec = song.records[diff.key];
                    
                    // 狀態按鈕樣式
                    const fcClass = rec.status === 'fc' ? 'fc-active' : '';
                    const apClass = rec.status === 'ap' ? 'ap-active' : '';


                    rowsHtml += `
                        <div class="diff-row">
                            <div class="diff-label ${diff.class}">${diff.label}</div>
                            
                            <input type="text" class="level-input" placeholder="Lv" 
                                value="${rec.level}" 
                                onchange="updateRecord(${song.id}, '${diff.key}', 'level', this.value)">
                            
                            <input type="text" class="memo-input" placeholder="備註..." 
                                value="${rec.memo}" 
                                onchange="updateRecord(${song.id}, '${diff.key}', 'memo', this.value)">
                            
                            <div class="btn-group">
                                <button class="status-btn ${fcClass}" onclick="setStatus(${song.id}, '${diff.key}', 'fc')">FC</button>
                                <button class="status-btn ${apClass}" onclick="setStatus(${song.id}, '${diff.key}', 'ap')">AP</button>
                            </div>
                        </div>
                    `;
                });


                // 底部播放清單輸入
                let footerHtml = `
                    <div class="card-footer">
                        <label style="font-size:0.8em; color:#666;">加入播放清單：</label>
                        <input type="text" placeholder="輸入清單名稱 (如: 手練)" 
                            value="${song.playlist}" 
                            style="width: 120px; padding:4px;"
                            onchange="updatePlaylist(${song.id}, this.value); renderSongs();">
                    </div>
                `;


                card.innerHTML = headerHtml + rowsHtml + footerHtml;
                container.appendChild(card);
            });


            if (displaySongs.length === 0) {
                container.innerHTML = '<p style="color:#666; grid-column: 1/-1; text-align:center;">沒有符合條件的歌曲，請新增歌曲或更改篩選條件。</p>';
            }
        }
    </script>


</body>
</html>